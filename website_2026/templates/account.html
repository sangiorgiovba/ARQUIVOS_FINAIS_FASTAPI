{% extends "layout.html" %}
{% block content %}
    <div class="content-section py-3 px-4 mb-4">
        <h2 class="mb-4">Configurações da Conta</h2>
      
        <div class="d-flex align-items-center mb-4">
            <img id="profileImage"
                 class="rounded-circle me-3"
                 src="/static/profile_pics/default.jpg"
                 alt="Profile picture"
                 width="100"
                 height="100">
            <div>
                <h5 id="displayUsername" class="mb-0"></h5>
                <p id="displayEmail" class="text-body-secondary mb-0"></p>
            </div>
        </div>
     
        <div class="mb-4">
            <h5>Utualizar Perfil</h5>
            <form id="updateProfileForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Usuario</label>
                    <input type="text"
                           class="form-control"
                           id="username"
                           name="username"
                           required
                           minlength="1"
                           maxlength="50">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>
                <button type="submit" class="btn btn-primary">Atualizar Perfil</button>
            </form>
        </div>
        <hr>
        
        <div class="mb-4">
            <h5>Foto de Perfil</h5>
            <p class="text-body-secondary">Image vai ser carregada em breve.</p>
            <input type="file" class="form-control" disabled>
        </div>
        <hr>
       
        <div class="mb-4">
            <h5>Trocar Senha</h5>
            <p class="text-body-secondary">Resetar senha em breve.</p>
            <form>
                <div class="mb-3">
                    <label class="form-label">Senha Atual</label>
                    <input type="password" class="form-control" disabled>
                </div>
                <div class="mb-3">
                    <label class="form-label">Senaha Nova</label>
                    <input type="password" class="form-control" disabled>
                </div>
                <div class="mb-3">
                    <label class="form-label">Confirmar Nova Senha</label>
                    <input type="password" class="form-control" disabled>
                </div>
                <button type="submit" class="btn btn-primary" disabled>Mudar Senha</button>
            </form>
        </div>
        <hr>
      
        <div class="mb-4">
            <button type="button" class="btn btn-light" id="logoutBtn">Sair</button>
        </div>
        <hr>
    
        <div class="mb-4">
            <h5 class="text-danger">Cuidado</h5>
            <p class="text-body-secondary">
                uma vez deletado a conta não poderá ser recuperada
            </p>
            <button type="button"
                    class="btn btn-outline-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteAccountModal">Deletar Conta</button>
        </div>
    </div>

    <div class="modal fade"
         id="deleteAccountModal"
         tabindex="-1"
         aria-labelledby="deleteAccountModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteAccountModalLabel">Deletar Conta?</h5>
                    <button type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fs-5">
                        tem certeza de que deseja deletar sua conta.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteAccount">Deletar Conta</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    <script type="module">
  import { getCurrentUser, getToken, logout, clearUserCache } from '/static/js/auth.js';
  import { getErrorMessage, showModal, hideModal } from '/static/js/utils.js';

  let currentUserId = null;

  // Load current user data and populate form
  async function loadUserData() {
    const user = await getCurrentUser();

    // Redirect to login if not authenticated
    if (!user) {
      window.location.href = '/login';
      return;
    }

    currentUserId = user.id;

  
    document.getElementById('displayUsername').textContent = user.username;
    document.getElementById('displayEmail').textContent = user.email;
    document.getElementById('profileImage').src = user.image_path;

 
    document.getElementById('username').value = user.username;
    document.getElementById('email').value = user.email;
  }

  
  const updateForm = document.getElementById('updateProfileForm');
  updateForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    const token = getToken();
    if (!token) {
      window.location.href = '/login';
      return;
    }

    const formData = new FormData(updateForm);
    const userData = Object.fromEntries(formData.entries());

    try {
      const response = await fetch(`/api/users/${currentUserId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify(userData),
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      if (response.status === 403) {
        document.getElementById('errorMessage').textContent =
          'voce nao e autorizado a editar esse perfil.';
        showModal('errorModal');
        return;
      }

      if (response.ok) {
        const data = await response.json();

       
        clearUserCache();

      
        document.getElementById('displayUsername').textContent = data.username;
        document.getElementById('displayEmail').textContent = data.email;

        document.getElementById('successMessage').textContent =
          'perfil atualizado com sucesso!';
        showModal('successModal');
      } else {
        const error = await response.json();
        document.getElementById('errorMessage').textContent = getErrorMessage(error);
        showModal('errorModal');
      }
    } catch (error) {
      document.getElementById('errorMessage').textContent =
        'problema ao atualizar perfil.';
      showModal('errorModal');
    }
  });

  
  document.getElementById('logoutBtn').addEventListener('click', logout);

 
  document.getElementById('confirmDeleteAccount').addEventListener('click', async () => {
    const token = getToken();
    if (!token) {
      window.location.href = '/login';
      return;
    }

    try {
      const response = await fetch(`/api/users/${currentUserId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
        },
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      if (response.status === 403) {
        document.getElementById('errorMessage').textContent =
          'nao autorizado para deletar esse conta.';
        hideModal('deleteAccountModal');
        showModal('errorModal');
        return;
      }

      if (response.status === 204) {
       
        localStorage.removeItem('access_token');
        window.location.href = '/';
      } else {
        const error = await response.json();
        document.getElementById('errorMessage').textContent = getErrorMessage(error);
        hideModal('deleteAccountModal');
        showModal('errorModal');
      }
    } catch (error) {
      document.getElementById('errorMessage').textContent =
        'occoreu un errore durante la cancellazione dell\'account.';
      showModal('errorModal');
    }
  });


  loadUserData();
    </script>
{% endblock scripts %}
